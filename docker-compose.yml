version: '3.8'

# Define a custom network for internal communication
networks:
  mlops_net:
    driver: bridge

services:
  # 1. Prediction API Service
  churn_prediction_api:
    build: .
    container_name: churn_prediction_api
    restart: always
    ports:
      # FastAPI application port (for Swagger UI/predictions)
      - "8000:8000"
      # Prometheus metrics server port (CRITICAL for monitoring setup)
      - "8001:8001" 
    volumes:
      # Mount the artifacts directory into the container
      - ./artifacts:/app/artifacts
    networks:
      - mlops_net

  # 2. Prometheus Monitoring Service
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus_server
    restart: always
    ports:
      - "9090:9090"
    volumes:
      # CRITICAL FIX: Maps the local prometheus.yml config to the required location inside the container
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    networks:
      - mlops_net
    depends_on:
      - churn_prediction_api

  # 3. Grafana Visualization Service
  # --- INSIDE docker-compose.yml (Corrected Grafana Service) ---
  grafana:
    image: grafana/grafana:latest
    container_name: grafana_dashboard
    restart: always
    ports:
      - "3000:3000"
    volumes: [] # <--- Ensures it is explicitly an empty array
    networks:
      - mlops_net
    depends_on:
      - prometheus